#! /bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --partition=gpu_a100
#SBATCH --gres=gpu:1
#SBATCH --constraint=scratch-node

# Setup env
module load 2025
module load CUDA/12.8.0
module load cuDNN/9.10.1.4-CUDA-12.8.0

eval "$(micromamba shell hook -s bash)"
micromamba activate scOmnom_env

# Copy our stuff
echo "Copying data to scratch..."
cp -R results/adata.filtered.zarr $TMPDIR/.

# Copy empty dir structure to preserve run info
mkdir -p "$TMPDIR/results/figures"
rsync -a \
  --include='*/' \
  --exclude='*' \
  results/figures/ \
  "$TMPDIR/results/figures/"

#Tidy up
PREVLOC=$(pwd)
cd $TMPDIR
pwd

# Set multicore vars
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
export OPENBLAS_NUM_THREADS=$SLURM_CPUS_PER_TASK
export MKL_NUM_THREADS=$SLURM_CPUS_PER_TASK
export NUMEXPR_NUM_THREADS=$SLURM_CPUS_PER_TASK
export IGRAPH_OPENMP_NUM_THREADS=$SLURM_CPUS_PER_TASK

# Run scOmnom
echo "Running scomnom..."
scomnom integrate -i adata.filtered.zarr -o results --benchmark-n-jobs $SLURM_CPUS_PER_TASK

# Copy the results back
echo "Copying results back to $PREVLOC"
rsync -a results $PREVLOC/.
echo "Done!"
